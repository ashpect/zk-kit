/**
 * @module @zk-kit/poseidon-proof
 * @version 1.0.0-beta.4
 * @file A library to generate and verify Poseidon proofs.
 * @copyright Ethereum Foundation 2024
 * @license MIT
 * @see [Github]{@link https://github.com/privacy-scaling-explorations/zk-kit/tree/main/packages/poseidon-proof}
*/
'use strict';

var bignumber = require('@ethersproject/bignumber');
var artifacts = require('@zk-kit/artifacts');
var proofPacking = require('@zk-kit/utils/proof-packing');
var snarkjs = require('snarkjs');
var crypto = require('ethers/crypto');
var utils = require('ethers/utils');
var abi = require('ethers/abi');

/**
 * Creates a keccak256 hash of a message compatible with the SNARK scalar modulus.
 * @param message The message to be hashed.
 * @returns The message digest.
 */
function hash(message) {
    return (BigInt(crypto.keccak256(utils.toBeHex(message, 32))) >> BigInt(8)).toString();
}

/**
 * Converts a bignumberish or a text to a bigint.
 * @param value The value to be converted to bigint.
 * @return The value converted to bigint.
 */
function toBigInt(value) {
    try {
        return utils.toBigInt(value);
    }
    catch (error) {
        if (typeof value === "string") {
            return utils.toBigInt(abi.encodeBytes32String(value));
        }
        throw TypeError(error.message);
    }
}

/**
 * Creates a zero-knowledge proof to prove that you have the preimages of a hash,
 * without disclosing the actual preimages themselves.
 * The use of a scope parameter helps ensure the uniqueness
 * and non-reusability of the proofs, enhancing security in applications like
 * blockchain transactions or private data verification.
 * If, for example, this package were used with Semaphore to demonstrate possession
 * of a Semaphore identity of a group of voters, the scope could be the poll's ID.
 * @param preimages The preimages of the hash.
 * @param scope A public value used to contextualize the cryptographic proof
 * and calculate the nullifier.
 * @param snarkArtifacts The Snark artifacts (wasm and zkey files) generated in
 * a trusted setup of the circuit are necessary to generate valid proofs
 * @returns The Poseidon zero-knowledge proof.
 */
async function generate(preimages, scope, snarkArtifacts) {
    scope = toBigInt(scope);
    // allow user to override our artifacts
    // otherwise they'll be downloaded if not already in local tmp folder
    snarkArtifacts ?? (snarkArtifacts = await artifacts.maybeGetSnarkArtifacts(artifacts.Project.POSEIDON, { parameters: [preimages.length] }));
    const { wasm, zkey } = snarkArtifacts;
    const { proof, publicSignals } = await snarkjs.groth16.fullProve({
        preimages: preimages.map((preimage) => hash(preimage)),
        scope: hash(scope)
    }, wasm, zkey);
    return {
        numberOfInputs: preimages.length,
        scope: bignumber.BigNumber.from(scope).toString(),
        digest: publicSignals[0],
        proof: proofPacking.packGroth16Proof(proof)
    };
}

var protocol = "groth16";
var curve = "bn128";
var nPublic = 2;
var vk_alpha_1 = [
	"20491192805390485299153009773594534940189261866228447918068658471970481763042",
	"9383485363053290200918347156157836566562967994039712273449902621266178545958",
	"1"
];
var vk_beta_2 = [
	[
		"6375614351688725206403948262868962793625744043794305715222011528459656738731",
		"4252822878758300859123897981450591353533073413197771768651442665752259397132"
	],
	[
		"10505242626370262277552901082094356697409835680220590971873171140371331206856",
		"21847035105528745403288232691147584728191162732299865338377159692350059136679"
	],
	[
		"1",
		"0"
	]
];
var vk_gamma_2 = [
	[
		"10857046999023057135944570762232829481370756359578518086990519993285655852781",
		"11559732032986387107991004021392285783925812861821192530917403151452391805634"
	],
	[
		"8495653923123431417604973247489272438418190587263600148770280649306958101930",
		"4082367875863433681332203403145435568316851327593401208105741076214120093531"
	],
	[
		"1",
		"0"
	]
];
var vk_delta_2 = [
	[
		[
			"13706475760348979760036830132895651891430491737107219958621176809506362280128",
			"15094254295547289439942981393834758601507709856123816894081402319319067362603"
		],
		[
			"17472468538458053188561218268165771051639899613697516029120202247645120422701",
			"9611658009779480807948574640638964844469564302868418561739992055788900932440"
		],
		[
			"1",
			"0"
		]
	],
	[
		[
			"15180666788705534827610422737971222956058023161017804972893229120603150084955",
			"1188397086375426276137519109903162790662567818704468623545423081800470081929"
		],
		[
			"3737810741722771095299202430101123098062130705975685029086383839858766968358",
			"4983412009368596099583857839039148741839212880019282834842756226581733611611"
		],
		[
			"1",
			"0"
		]
	],
	[
		[
			"6211041026018748191163906117178155784175962691243500460169640118124452284231",
			"17696448039619648997097518949287333460247451463117808440030519649067365464316"
		],
		[
			"4694150310306281406024151693082549614597412869848307724864440890121133836524",
			"14440068243910328404000992063301586075121227158898928167215939090557336765482"
		],
		[
			"1",
			"0"
		]
	],
	[
		[
			"14193821257031041430231358593800492638909684058022317080509744583977675366832",
			"10876379014653354623732114659569294940564984325729163201568689357439498542930"
		],
		[
			"10595072504420925738131095919486520165643951324697929736534159142453919260763",
			"3454845048774741983752146266576153838996767674208500946172152148094511835905"
		],
		[
			"1",
			"0"
		]
	],
	[
		[
			"1003892686954891785289839116329667185817159239506774436619099189529939041155",
			"2048554130836948199097313619535151646623815860862265051887872449243408398716"
		],
		[
			"4318997748563778256507392799636547197157436229273000606489915385570697153121",
			"19965821763797383443005801468643400526335031871581290810839074333215915406487"
		],
		[
			"1",
			"0"
		]
	],
	[
		[
			"15105765114956680836202210865231598967911397891786741290322437544189547676069",
			"2538517056712117700030178042637069279845990264890526820288638680819397475661"
		],
		[
			"18786175189553096411319802476068302093927016621109621952471523317418867111033",
			"11118998069112172383489570967948360694059714536079444439788716867327601952550"
		],
		[
			"1",
			"0"
		]
	],
	[
		[
			"20224324394147974445779565962971950632962554757530491483681462130445623352765",
			"772834050376066155784310347981559455633842948269967582007664546083952408842"
		],
		[
			"587231629154336209117977728475360391033648110237882997857636585583099252369",
			"8156364543337382412065835984008571522890186133149360637585592814441052989754"
		],
		[
			"1",
			"0"
		]
	],
	[
		[
			"9588145097807616139806255459174523584399805047922458106080377362933935185769",
			"6026000143945998675552149766329809690660791270086899201587495944007453963347"
		],
		[
			"15264150390135947870842827119463843726672893780143494505046740339336093366699",
			"15523361548983791715932687123569178951275102244621508161625013683787254886505"
		],
		[
			"1",
			"0"
		]
	],
	[
		[
			"3486745667680205672380019263514710300262728136652076492333254046099735699561",
			"973879074474437021110465509434796545239232969887114143741170087941907614386"
		],
		[
			"19221738248747450008801118888473856216956413377039324068898288016724020077178",
			"19928750574388854086719009301005254042688918602684673384046393958626050880463"
		],
		[
			"1",
			"0"
		]
	],
	[
		[
			"16735010820086440457822128600860506459990848760928948998677658671284641680963",
			"7937712084823346326392481190972656358275773550148656270785512287375696655778"
		],
		[
			"3257111810373607833130194420207613638319621703687656308032660729147165306684",
			"8080623892303381379471296001408428971090395719052751791967004968894517526394"
		],
		[
			"1",
			"0"
		]
	],
	[
		[
			"35030490672781228124533603032626008638139887250038393694172399695097818202",
			"13022101738995931139921019845290549216603353789758353928016647555206190702928"
		],
		[
			"15646293047440613625912023853894166039961922480354753250479753527892426757710",
			"13419602005611044580692931509922344039391713877846013336412192194494195867848"
		],
		[
			"1",
			"0"
		]
	],
	[
		[
			"11512154716943179621127741535888355122618126528504984792632463393864126008061",
			"2178219644666255569220492548528637985903642915837303417325446256900749043701"
		],
		[
			"788731803577442368448609173252962986339560724309698965677024701609911443637",
			"5737934927786107811248750101457662106085184518848705086852615307177934599309"
		],
		[
			"1",
			"0"
		]
	],
	[
		[
			"18257194318692896308745576039437647331257011226564483433086650421046318407806",
			"17506882052276945845187329696321964532711476188006089198454749961446808405720"
		],
		[
			"3536562505411576195780948964724932192916330638961417184885152510348674608201",
			"18190009899872985856863492559738353313633428842354802978966237879451252642905"
		],
		[
			"1",
			"0"
		]
	],
	[
		[
			"16546337281054866043515426698314217271507447374392786624208659036445884156594",
			"3120905705409001137978298173991770910603543584072180907701344975205611550314"
		],
		[
			"10555933778717815873380035333114291715678986583375405555723279122922324038407",
			"2896189065474187800133294952821664399120580893757838223278485520249036482597"
		],
		[
			"1",
			"0"
		]
	],
	[
		[
			"3026288273069384324071143122068968036616025200747850467104893129503675220411",
			"8744116588788634626342323016437456090745524919721896268429888897209902525525"
		],
		[
			"7849496130697821859109161813243343499709542871530989602818475312489560728108",
			"14887336996614953825581710705593593104354930474962017366343388578993699081126"
		],
		[
			"1",
			"0"
		]
	],
	[
		[
			"3690425969979591046911013328616404896021771118499376399856938790389173593466",
			"2933066416177670820313394209576390670642997566064220267324974784872140417347"
		],
		[
			"15770365350783203379305503176400894252352489685188765698118141075675371145178",
			"20143372781510612013237176910002489335593925776546814410387131354374493170367"
		],
		[
			"1",
			"0"
		]
	]
];
var vk_alphabeta_12 = [
	[
		[
			"2029413683389138792403550203267699914886160938906632433982220835551125967885",
			"21072700047562757817161031222997517981543347628379360635925549008442030252106"
		],
		[
			"5940354580057074848093997050200682056184807770593307860589430076672439820312",
			"12156638873931618554171829126792193045421052652279363021382169897324752428276"
		],
		[
			"7898200236362823042373859371574133993780991612861777490112507062703164551277",
			"7074218545237549455313236346927434013100842096812539264420499035217050630853"
		]
	],
	[
		[
			"7077479683546002997211712695946002074877511277312570035766170199895071832130",
			"10093483419865920389913245021038182291233451549023025229112148274109565435465"
		],
		[
			"4595479056700221319381530156280926371456704509942304414423590385166031118820",
			"19831328484489333784475432780421641293929726139240675179672856274388269393268"
		],
		[
			"11934129596455521040620786944827826205713621633706285934057045369193958244500",
			"8037395052364110730298837004334506829870972346962140206007064471173334027475"
		]
	]
];
var IC = [
	[
		[
			"19490069286251317200471893224761952280235157078692599655063040494106083015102",
			"15613730057977833735664106983317680013118142165231654768046521650638333652991",
			"1"
		],
		[
			"1563543155852853229359605494188815884199915022658219002707722789976065966419",
			"858819375930654753672617171465307097688802650498051619587167586479724200799",
			"1"
		],
		[
			"3808889614445935800597561392085733302718838702771107544944545050886958022904",
			"13293649293049947010793838294353767499934999769633605908974566715226392122400",
			"1"
		]
	],
	[
		[
			"16314216713263812259250797674288246089499962988847721936436321307378336592095",
			"11117018508219521589294010525047040473526927855655175840819026305851777765475",
			"1"
		],
		[
			"1489322533177716064948875575926922312447753206440552240050276050387942900438",
			"12165171936521766159101308675345703232678022163590860407018275007604526533982",
			"1"
		],
		[
			"6960512141760522400088094283402946234174678264161998436678471144494429317205",
			"20452221478986281611081187536083135297872601218015116497971140905889313743165",
			"1"
		]
	],
	[
		[
			"5777689742082005715270723054664547692838725793611115367188093577876286319897",
			"10454075320040159670083485671678517137046698003354189208581600890161008983741",
			"1"
		],
		[
			"2642098050452795834338379096531211995188230502015980900343056782376948339687",
			"14124928114351826183770480091879839058993316965479121067425548494569501532377",
			"1"
		],
		[
			"15148305354610832828183744524377641188304327550206135491675778059310640673138",
			"4893932453452103247939341257230497114673566246321965048356049178501986246725",
			"1"
		]
	],
	[
		[
			"20915408346262913832848096115897083424191782014558753292028210172329556489891",
			"20477324302289652567921221514286340472175521364608819396373915910203052137234",
			"1"
		],
		[
			"18109741480520484438583085965849393053790689016366934256867378379242288457686",
			"13619404282196516647345713373498249513238472014983969488668509336400876494311",
			"1"
		],
		[
			"11765051984214979755732420036077340861427462185621265051697279669517347262729",
			"17955014055238146126632398568346244655216767709119096967135392509704733491844",
			"1"
		]
	],
	[
		[
			"16481192909169214010392200653283275987325709982486805651427539789368110643965",
			"9600634861073295096550032788240078277063249868126439630400649560046604582951",
			"1"
		],
		[
			"8716855468226815195040220782769615065622022528430076687863434910949019560115",
			"5144800664114113488204783976150442697336491675680169297817164380798395482501",
			"1"
		],
		[
			"14279736595764028921246337982363760894086288686502096693089864776683515170827",
			"6403920333376154835269627270297651759933138762638770910356946391337790253284",
			"1"
		]
	],
	[
		[
			"19427312127307233114043544532010141761737668406845711063737151756341969518115",
			"19497001261488307700108517382899830645465934586931341109009380207822933853538",
			"1"
		],
		[
			"18850362688565117327473227965231396785394256896015207979763863952560092318905",
			"19845569423696587838445968823785398846474692097131528981298815653580718689592",
			"1"
		],
		[
			"840756707954101069142723209419963051403617828309738249721569313340266702555",
			"5780878828618912743300640785478897234401371585090207748306483967163886135973",
			"1"
		]
	],
	[
		[
			"546027003027570802029398089463935069893813566041096597150463996505426053761",
			"14014506297856732287662693039958827017385498211983409974050280467221019100956",
			"1"
		],
		[
			"11189450817957093937106621030429756748082057026435929105575426657564882386802",
			"4509940161802247020195238005432388756974430777298874217078810778762343128329",
			"1"
		],
		[
			"17755051906548101790853642244089657439893646632620305489913721603670784250069",
			"8904395938511806014192726926365647143660749609881308620335528629337973923713",
			"1"
		]
	],
	[
		[
			"13213356598199847269699632272566750853813594809392061230885705868548131437637",
			"895153038996134925237046737026834738970028513999527722413774967155341310435",
			"1"
		],
		[
			"471993200552326549203598917362027198173949469152420169709884479126339292271",
			"14174598991630085582601473833852162779297438091497079256707119545704654236327",
			"1"
		],
		[
			"12711216628891510607753358833453031250654744351039303007840207871043484081967",
			"2173441600878949731991469203266793443327643325686272565914594621955348362526",
			"1"
		]
	],
	[
		[
			"18887882527574578188655084466752577798014308073107368854351124461973580787910",
			"651081314890381475167064795691942982045799761791181574107224090162291115938",
			"1"
		],
		[
			"18346790043873442676694511075634026436566932544111333965589071781644561478536",
			"17900923331213210712376047327769111823453727818721826870886503477889503452320",
			"1"
		],
		[
			"8253813990164202614612417399858531257146056572623956512005125798531486848635",
			"1912679600385690796934031421829930466203893397004242578775877223967293806293",
			"1"
		]
	],
	[
		[
			"798266006634704296356807896304782617057267109446481684272074776676559365377",
			"2119139191057773416624154862008823601747165120947596460685518302760052477540",
			"1"
		],
		[
			"17743954615775269739473094351635203185883870143434239552566169722164063573412",
			"4830438380339493939707702694553275524057591153138914848741234629532535265855",
			"1"
		],
		[
			"3796651289821923027753272300677071875561083096603899517484713434570556592125",
			"6095027127012064440741913106185486005983523295112206123623056096004008125125",
			"1"
		]
	],
	[
		[
			"20896314949419669765122080719670563957005377809880391165219112342045724637250",
			"4832396215740174951649707718991048955348422076401947958263135738277030640702",
			"1"
		],
		[
			"16593634394872419207033083223572861328698354554381035892795187358904450228380",
			"9701239775839670407542964511868405320901788463030859950701125893205826970190",
			"1"
		],
		[
			"9167350343757520738096817169608613527226407725783625898259506700381039420314",
			"15333436194900493791133741272915135408304144665526863658315589456211375313779",
			"1"
		]
	],
	[
		[
			"16543510929460662532386886546901011043138961778902766992229923474505072642586",
			"7288111264950369152610735086150458884933258785894500389698639872930852462663",
			"1"
		],
		[
			"1994453756596995022826442237786101382469308865506647442894126417820462624694",
			"12283578265208666129358338863068849999489745351625672248537470813852350624388",
			"1"
		],
		[
			"15764090122090539610137315975980769027497965597241892197050094573700859685031",
			"16127936860826353217400374080861290401287757977000068338683474176835798271546",
			"1"
		]
	],
	[
		[
			"6814792559890925047818282843694260141378659909315003118590070069849331402952",
			"11487140246612953459078678078682837634162621680655211065906468894225318882237",
			"1"
		],
		[
			"17360742729430479877984059553981878760229504858672709960462279772992971228248",
			"13690322572462596796349153488376752918916016991516526844586250585646241977694",
			"1"
		],
		[
			"4906588735496489330523967649950093670925034337304754138190133951387294341057",
			"5218460120914285994082898891708144613476357035579628488245805720152917550286",
			"1"
		]
	],
	[
		[
			"13282248485020570420370930767608741307342877737916403488447236834118682154819",
			"13643529490169828084500852304502939907684096114138860997087808495233563072227",
			"1"
		],
		[
			"5830864539585072595043466360478712864357530872155710302353766522442537458812",
			"19630573211115930246472127117269713022239927640438155481395734635211224817450",
			"1"
		],
		[
			"19595834379767327691325219705384917752650436054074663235665180007150886015402",
			"21776132326533679474262043062256203971768128822420306261908561590372896137645",
			"1"
		]
	],
	[
		[
			"10672190684358488826593441743377739192693575863202325591312856408936680120020",
			"9717978615445017015997632608006427441955061002796104162232282550809107181476",
			"1"
		],
		[
			"5828007128983331222838337093606954646925973608593933197261396517201848325094",
			"12964702707860770903006771736549085339329027071623624221129924563214896441694",
			"1"
		],
		[
			"11332800322397218917690923441720418652504295099919694685995980166401299180449",
			"277445635710795537937356070051610985002729781994507435749406622715010456375",
			"1"
		]
	],
	[
		[
			"86775556699891941583123276431604861117607918118921404923042712889138274879",
			"14759328092142878568124943477991930809809651785962195940712634115221722222569",
			"1"
		],
		[
			"20587317296408903557562082822150306305156789836788233257760942330988928993338",
			"12774638026052488480510449004117723866673354480831773481619251986421580001942",
			"1"
		],
		[
			"18790156527059336816249174042938006922945801451739084347405900279382431369589",
			"20245819713646952948400401365133759240714478548907783423055257617618511044262",
			"1"
		]
	]
];
var verificationKeys = {
	protocol: protocol,
	curve: curve,
	nPublic: nPublic,
	vk_alpha_1: vk_alpha_1,
	vk_beta_2: vk_beta_2,
	vk_gamma_2: vk_gamma_2,
	vk_delta_2: vk_delta_2,
	vk_alphabeta_12: vk_alphabeta_12,
	IC: IC
};

/**
 * Verifies that a Poseidon proof is valid.
 * @param proof PoseidonProof
 * @returns True if the proof is valid, false otherwise.
 */
function verify({ numberOfInputs, scope, digest, proof }) {
    const verificationKey = {
        ...verificationKeys,
        vk_delta_2: verificationKeys.vk_delta_2[numberOfInputs - 1],
        IC: verificationKeys.IC[numberOfInputs - 1]
    };
    return snarkjs.groth16.verify(verificationKey, [digest, hash(scope)], proofPacking.unpackGroth16Proof(proof));
}

exports.generate = generate;
exports.verify = verify;
